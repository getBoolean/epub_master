# shu_epub

[![codecov](https://codecov.io/gh/getBoolean/shu_epub/branch/main/graph/badge.svg?token=LN8VSR2UER)](https://codecov.io/gh/getBoolean/shu_epub)

[![Open in Gitpod](https://img.shields.io/badge/Open_in_Gitpod-white.svg?style=flat&logo=data:image/png;base64,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)](https://gitpod.io/#https://github.com/getBoolean/shu_epub)

<!-- [![Open in Gitpod](https://gitpod.io/button/open-in-gitpod.svg)](https://gitpod.io/#https://github.com/getBoolean/shu_epub) -->

A Dart EPUB parser built from the ground up, and designed to support a variety of use cases and custom implementations such as on-device caching and serving content from a server. This package is current WIP and is NOT yet usuable.

## Planned Features

- EpubController - An abstract class intended to be extended to enable flexibility inspired by Flutter's Widget class
- EpubArchiveController - Implements EpubController, reads in bytes of an .epub file for reading
- (flutter_shu_epub) EpubCacheController - Extracts ePub contents onto an Android or iOS device and caches the location, allowing for
  the reader to only load the needed files into memory

and more...

## Progress and Plans

### shu_epub (this package)

- Provided EpubArchiveController for reading EPUB files, independent from dart:io
- Abstract EpubController for custom implementations, such as serving epubs from
  the web or caching epubs on the file system
- Readers which read individual file data, they do not need the entire
  EPUB loaded into memory. This allows the device to save memory
- Models
  - **Epub**
  - Container
    - **ContainerFile**
    - **Rootfile**
  - Package
    - **PackageFile**
    - **PackageIdentity**
    - **PackageMetadata**
  - **Exception**
  - ... many more
- Controllers

  - **EpubController**
    - Abstract
    - Future getFilePaths - Method to get filepaths to all files
    - Future getFileBytes - Method to get bytes of file from filepath
    - Create instance of EPUB object when controller is created
    - Getter for EPUB object
  - **EpubArchiveController** extends **EpubController**
    - Creates EPUB object from loaded `.epub` file bytes, and supported media types
    - Overrides getFilePaths and getFileBytes to use `Archive`/`ArchiveFile`
  - **EpubContainerController**
    - Given container (`META-INF/container.xml`) file bytes, and supported media types
  - **EpubPackageController**
    - Given rootfile (`.opf`) file bytes
  - **EpubNavigationController**
    - Given navigation (`.ncx`) file bytes
  - **EpubContentsController**
    - Given file content bytes and the type and content it is (such as `.xhtml`)

- [x] EpubContainerReaderController
  - [x] Default constructor from Uint8List
  - [x] fromXmlString factory
  - [x] getVersion
  - [x] getRootfiles
  - [x] Tests
- [x] EpubPackageReaderController
  - [x] Default constructor from Uint8List
  - [x] fromXmlString factory
  - [x] getPackageIdentity
  - [x] getPublicationMetadata
  - [x] getManifest
  - [x] getSpine
  - [x] getGuide
  - [x] getTours
  - [ ] Support Epub 2 [Out-Of-Line XML Islands](http://idpf.org/epub/20/spec/OPF_2.0.1_draft.htm#Section2.3.1.2), removed in Epub 3
- [x] EpubNavigationReaderController
  - [x] Default constructor from Uint8List
  - [x] fromXmlString factory
  - [x] getVersion
  - [x] getLanguage
  - [x] getHead
  - [x] getDocTitle
  - [x] getDocAuthors
  - [x] getNavigationMap
  - [x] getPageList
  - [x] getNavigationLists
- [x] EpubDetailsReaderController
  - Combines the container, package, and navigation into one class
- [ ] Publication/Content Controller
- [ ] Epub Controllers
  - [ ] EpubControllerBase
    - [x] getDetails
    - [x] getFileBytes
    - [x] getFiles
    - others tbd...
  - [x] EpubArchiveController
  - [x] EpubArchiveIOController
  - [x] (In example.dart) EpubExtractedController
    - requires dart:io, so not included in this package
- [ ] EpubBook class to simplify access to Epub content and metadata
  - [x] EpubDetails (contains EpubContainer, EpubPackage, and EpubNavigation)
  - [ ] EpubFiles (all files listed in manifest)
    - [ ] Don't include items that are Out-Of-Line XML Islands
  - [ ] EpubReadingOrder (spine)
    - [ ] Manifest items included in the spine, in the same order as listed in the spine
  - [ ] EpubTableOfContents (ncx)
    - [ ] Navigation Metadata
    - [ ] Navigation Title
    - [ ] Navigation Author
    - [ ] Navigation Points (navMap)
      - [ ] File
      - [ ] CFI Location
    - [ ] Pages *Optional* (pageList)
    - [ ] Other Navigation Lists *Optional* (navList)
- [ ] CFI Generator

### flutter_shu_epub (tenative)

- Uses Models and Parsers from dart_epub
- Platform specific implementation to handle caching, only loads the
  files it needs into memory
- Controllers
  - **EpubCacheController** extends **EpubController**
    - Reads from a `.epub` file extracted onto the file system, so
      only the files needed are loaded into memory
    - Overrides getFilePaths and getFileBytes to use dart:io `File`
  - **EpubCacheManagerSingleton**
    - Function to read an `.epub` file into memory and
      cache it on local storage for quick access later, with an optional
      id. The id is returned and it should be saved persistently with
      a package such as Hive
    - Local Database for each cached EPUB with **EpubCache**, which includes
      information about the EPUB and the **EpubCacheController** associated
      with it
    - Clear cache
    - Delete epub from cache
    - Get all cached epub information
- Models
  - **EpubCache**
    - uid, can be specified
    - epub name
    - original filename
    - cache path
    - epubCacheController
- Widgets
  - Table of Contents Panel (Side panel, bottom sheet, or whole/half page)
  - Contents View (Vertical scrolling or paged)
    - Loading view while reading from `.xhtml` file
    - How HTML+CSS is rendered is TBD
    - Text selection
      - Add buttons to popup
      - Custom text selection popup builder
    - Text highlighting (maybe use CFIs?)
    - Option to override font, font size, line spacing
    - Go to CFI location (scroll or page)
    - Go to CFI History
    - Optional page between chapters
    - Page turn transitions
    - Bookmark support (through CFIs)
    - Searchable
  - Epub Title
  - Pictures ListView
  - Search Panel/Page
    - Search current chapter or all chapters

## Testing

Run tests with the following command

> `dart test`

### Test Coverage

Generate test coverage by running the following commands

1. `dart pub global activate coverage`
2. `dart test --coverage="coverage"`
3. `dart pub global run coverage:format_coverage --lcov --in=coverage --out=coverage.lcov --packages=.packages --report-on=lib`

## Resources

- [EPUB Specifications](http://idpf.org/epub/dir/)
- [EPUB Accessibility 1.0](http://idpf.org/epub/a11y/accessibility.html)
- [Schema.org Accessibility Properties for Discoverability Vocabulary](https://www.w3.org/2021/a11y-discov-vocab/latest/)
